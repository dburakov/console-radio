# 
import time
import argparse
import requests
import hashlib
import redis
import json
import shutil


redis_pool = redis.StrictRedis(host='localhost', port=6379, db=3)


def get_tracks(qname=''):
    ts = time.time()
    # url = 'https://radio.yandex.ru/api/v2.1/handlers/radio/user/270453501/tracks?queue='+qname+'&external-domain=radio.yandex.ru&overembed=yes&__t=1471895027894'
    url = 'https://radio.yandex.ru/api/v2.1/handlers/radio/activity/wake-up/tracks?queue='+qname+'&external-domain=radio.yandex.ru&overembed=no&__t=' + str(ts)

    headers = {
        'X-Retpath-Y': '-',
        # 'Cookie': 'Session_id=3:1472313987.5.0.1472313963000:YS5VXQ:41.0|270453501.24.2.2:24|150707.721938.Y0a_8wRdhS1stARnY1ABTqFZfrk; '
    }

    print url
    r = requests.get(url, headers=headers)
    print r.status_code
    # print r.text
    return r.json()['tracks']


def get_mp3_url(track):

    url = 'https://radio.yandex.ru/api/v2.1/handlers/track/' + track + '/radio-web-activity-sex-direct/download/m?hq=0&external-domain=radio.yandex.ru&overembed=no&__t=1472309630661'
    # url = 'https://radio.yandex.ru/api/v2.1/handlers/track/' + track + '/radio-web-user-270453501-direct/download/m/sy/net/match_r1103.html?__t=1471374568089'
    headers = {'X-Retpath-Y': 'https%3A%2F%2Fradio.yandex.ru%2Fuser%2Fdebeet'}
    r = requests.get(url, headers=headers, timeout=3)
    # print r.json()
    url2 = r.json()['src']

    # print url2
    r = requests.get(url2 + '&format=json', timeout=3)
    stage2 = r.json()

    m = hashlib.md5()
    to_hash = 'XGRlBW9FXlekgbPrRHuSiA' + stage2['path'][1:] + stage2['s']
    m.update(to_hash)
    hashsum = m.hexdigest()
    url3 = 'https://%s/get-mp3/%s/%s%s' % (stage2['host'], hashsum, stage2['ts'], stage2['path'])

    return url3


def print_track(track):
    if track['type'] != 'track':
        return
    print 'id: %s \t name: %s \t\t\t artist: %s, album: %s' % (
        track['track']['id'],
        track['track']['title'],
        track['track']['artists'][0]['name'],
        track['track']['albums'][0]['id'],
    )


def store_track(track):
    if track['type'] != 'track':
        return
    key = track['track']['id']
    value = {
        'name': track['track']['title'],
        'artist': track['track']['artists'][0]['name'],
        'album': track['track']['albums'][0]['id']
    }
    redis_pool.set(key, json.dumps(value))
    print 'stored: %s' % json.loads(redis_pool.get(key))


def get_latest():
    # qstart = ''
    # q = qstart.split(',')
    # ----- 69 - -----
    # q len: 346
    q = []
    # q = ['14701552:1610687', '14701552:1610687', '7780:2492816', '25903468:2983328', '17303:4879', '16549426:1871617', '20057:87200', '25063570:2945938', '17194913:2356971', '12480:90099', '2146169:745493', '13639277:1483046', '22029634:3312521', '241786:24481', '10505822:1982142', '16273723:1776601', '2840:26691', '532908:57069', '10543:2497725', '9976316:1990711', '14701545:1610687', '5426:584', '26249615:3119071', '26719974:3187221', '23331752:2686581', '975:6041', '814369:2490407', '21501887:2522992', '801222:89409', '15772:2509219', '14690773:1609071', '26309960:3127880', '9966390:1068284', '10506346:1137181', '16524290:1808865', '20217926:2825507', '4376:88388', '41315:3485809', '7554:791', '14701557:1610687', '9951085:1833649', '9966150:1068194', '22473:4855', '16177514:1828357', '36661:86066', '68235:60492', '18827:6303', '547688:58707', '5251304:578913', '12743:1688367', '3692242:413035', '16408653:1795815', '370814:37772', '1598248:160556', '9976314:1990711', '7556:791', '813824:409676', '4209889:474188', '530401:2488278', '27965:2345', '2890529:445743', '20469853:2329909', '15761:2509219', '15995253:1745266', '10509962:1137588', '3703084:1597165', '20717346:2363425', '529895:56829', '37384:89827', '18644154:2074429', '15495586:1698735', '15039:1397', '2137790:210831', '16780420:1840373', '17311408:1908313', '9987082:1073131', '3670311:1133973', '12502:1189', '9474:957', '14701549:1610687', '2470798:261513', '434900:45004', '15271:3548', '15753487:1716258', '18900642:2110710', '70397:5977', '532906:57069', '4197120:1999283', '18371442:2067116', '529882:56829', '67884:2243022', '12364:3184989', '17278443:2305595', '9328:2757069', '20053:86419', '14182015:1543767', '18079551:2003176', '10451976:1132000', '6314570:688566', '14701542:1610687', '25905123:3069240', '9968132:1782091', '14688968:1608769', '9459474:1003108', '12846:1738', '7284:8213', '3874601:434317', '9610:9341', '16273721:1776601', '14264:1336', '21611146:2476503', '4196922:561528', '17311412:1908313', '545939:58505', '9444267:1694122', '9447618:1099950', '1057951:119384', '16321483:1784392', '8403762:1165233', '14701553:1610687', '28148549:3363140', '39387:2494169', '9769:2463', '23752:4973', '9439965:1116658', '560468:60062', '3962293:446009', '15782:1588', '4752890:529904', '17826994:3216062', '14283:1336', '20469833:2329909', '14200:1330', '23099862:2656609', '2628253:273026', '18351182:2038152', '17341427:1912595', '17563816:486804', '16281191:1777801', '14701555:1610687', '13323:5981', '12272:2078802', '545651:3442224', '649288:299505', '7788:89816', '4723180:1540196', '25490:2155', '3690976:421063', '234659:23850', '24153:2480958', '482489:51085', '9443050:1049651', '4118:88434', '1590150:159854', '10970:89058', '20094:85861', '16554025:1812916', '8086:85625', '7636824:408276', '14701548:1610687', '528358:56669', '795391:88976', '2196112:217374', '4789:198', '562:9967', '14688413:2368030', '14079:2509225', '12651:2500985', '14358536:1511796', '11936:90787', '530065:56856', '6571667:709320', '17833450:2043556', '14690774:1609071', '10823:1053', '26149:2481096', '1590255:1917585', '800804:89358', '357767:36016', '14701559:1610687', '22065552:2513599', '5407128:606543', '13144:2507283', '22434771:217636', '9353:2078802', '739019:82081', '22020283:2534789', '14461538:1578081', '14071:2509225', '360079:36420', '4117:88434', '21261:2711', '1590245:159865', '9447191:1001705', '12362:3184989', '4430450:504155', '545628:214201', '10235:89888', '270951:36262', '21043:3595068', '11568:90982', '2412:7786', '5251326:669163', '13599:23808', '17782153:1966374', '23757402:2748151', '14701552:1610687', '7780:2492816', '25903468:2983328', '20057:87200', '17303:4879', '545861:413587', '17336002:2656609', '529885:56829', '16549426:1871617', '13639277:1483046', '25063570:2945938', '12480:90099', '22029634:3312521', '17194913:2356971', '10505822:1982142', '16273723:1776601', '2146169:745493', '10543:2497725', '9976316:1990711', '14701545:1610687', '5426:584', '532908:57069', '241786:24481', '2840:26691', '26249615:3119071', '26719974:3187221', '21254:2711', '2622164:492440', '15772:2509219', '14690773:1609071', '10506346:1137181', '26309960:3127880', '9966390:1068284', '7988:835', '13423:1274', '21172:87810', '532771:57053', '9531:445812', '14701557:1610687', '9951085:1833649', '9966150:1068194', '22473:4855', '16177514:1828357', '36661:86066', '68235:60492', '18827:6303', '547688:58707', '5251304:578913', '12743:1688367', '16408653:1795815', '3692242:413035', '370814:37772', '1598248:160556', '18302549:2032236', '535009:57371', '20056:85861', '234703:2395430', '524546:56256', '10073809:1085385', '6345:655', '10077:2711', '11197144:1215028', '5250170:1604075', '23331752:2686581', '975:6041', '16524290:1808865', '20217926:2825507', '21501887:2522992', '368160:58447', '22031304:2536529', '3670854:1670468', '25494:2153', '20479637:2335682', '15761:2509219', '9976314:1990711', '813824:409676', '2890529:445743', '814369:2490407', '3670311:1133973', '434900:45004', '12502:1189', '15753487:1716258', '2470798:261513', '9987082:1073131', '17311408:1908313', '9474:957', '18371442:2067116', '15271:3548', '529882:56829', '67884:2243022', '12364:3184989', '70397:5977', '9328:2757069', '14701549:1610687', '20053:86419', '18079551:2003176', '10451976:1132000', '14182015:1543767', '14688968:1608769', '17278443:2305595', '4197120:1999283', '9968132:1782091', '18900642:2110710', '3874601:434317', '7284:8213', '532906:57069', '9610:9341', '6314570:688566', '12846:1738', '14264:1336', '17311412:1908313', '4196922:561528', '9459474:1003108', '14701542:1610687', '9444267:1694122', '25905123:3069240', '545939:58505', '21611146:2476503', '28148549:3363140', '9769:2463', '39387:2494169', '16273721:1776601', '23752:4973', '1057951:119384', '16321483:1784392', '9447618:1099950', '8403762:1165233', '16273834:1776623', '7556:791', '4376:88388', '41315:3485809', '4209889:474188', '530401:2488278', '5000230:551201', '22020303:2534795', '2626092:459112', '801222:89409']
    for i in range(0, 80):
        print '----- %s ------' % i
        print 'q len: %s ' % len(q)
        print q
        qtext = ','.join(q)
        print qtext
        tracks = get_tracks(qtext)
        for track in tracks:
            if track['type'] == 'track':
                print 'added to queue: %s' % str(track['track']['id']) + ':' + str(track['track']['albums'][0]['id'])
                q.append(str(track['track']['id']) + ':' + str(track['track']['albums'][0]['id']))
                # print_track(track)
                store_track(track)


def extend_stored_tracks_with_url():
    for tid in redis_pool.keys('*'):
        stored = json.loads(redis_pool.get(tid))
        print stored
        if 'url' not in stored:
            url = get_mp3_url(tid)
            new_value = stored
            stored['url'] = url
            redis_pool.set(tid, json.dumps(new_value))


def download_tracks():
    i = 0
    all_tracks = redis_pool.keys('*')
    all_count = len(all_tracks)
    for tid in all_tracks:
        print 'processing %s/%s' % (i, all_count)
        i += 1
        stored = json.loads(redis_pool.get(tid))
        # print stored
        if 'url' in stored:
            response = requests.get(stored['url'], stream=True)
            with open('downloaded/%s - %s.mp3' % (stored['artist'], stored['name']), 'wb') as out_file:
                shutil.copyfileobj(response.raw, out_file)
            del response
            # return


if __name__ == '__main__':
    # print get_tracks('17782153:1966374,23757402:2748151,14701552:1610687,7780:2492816,25903468:2983328,17303:4879,16549426:1871617,20057:87200,25063570:2945938,17194913:2356971,12480:90099,2146169:745493,13639277:1483046,22029634:3312521,241786:24481,10505822:1982142,16273723:1776601,2840:26691,532908:57069,10543:2497725,9976316:1990711,14701545:1610687,5426:584,26249615:3119071,26719974:3187221,23331752:2686581,975:6041,814369:2490407,21501887:2522992,801222:89409,15772:2509219,14690773:1609071,26309960:3127880,9966390:1068284,10506346:1137181,16524290:1808865,20217926:2825507,4376:88388,41315:3485809,7554:791,14701557:1610687,9951085:1833649,9966150:1068194,22473:4855,16177514:1828357,36661:86066,68235:60492,18827:6303,547688:58707,5251304:578913,12743:1688367,3692242:413035,16408653:1795815,370814:37772,1598248:160556,9976314:1990711,7556:791,813824:409676,4209889:474188,530401:2488278,27965:2345,2890529:445743,20469853:2329909,15761:2509219,15995253:1745266,10509962:1137588,3703084:1597165,20717346:2363425,529895:56829,37384:89827,18644154:2074429,15495586:1698735,15039:1397,2137790:210831,16780420:1840373,17311408:1908313,9987082:1073131,3670311:1133973,12502:1189,9474:957,14701549:1610687,2470798:261513,434900:45004,15271:3548,15753487:1716258,18900642:2110710,70397:5977,532906:57069,4197120:1999283,18371442:2067116,529882:56829,67884:2243022,12364:3184989,17278443:2305595,9328:2757069,20053:86419,14182015:1543767,18079551:2003176,10451976:1132000,6314570:688566,14701542:1610687,25905123:3069240,9968132:1782091,14688968:1608769,9459474:1003108,12846:1738,7284:8213,3874601:434317,9610:9341,16273721:1776601,14264:1336,21611146:2476503,4196922:561528,17311412:1908313,545939:58505,9444267:1694122,9447618:1099950,1057951:119384,16321483:1784392,8403762:1165233,14701553:1610687,28148549:3363140,39387:2494169,9769:2463,23752:4973,9439965:1116658,560468:60062,3962293:446009,15782:1588,4752890:529904,17826994:3216062,14283:1336,20469833:2329909,14200:1330,23099862:2656609,2628253:273026,18351182:2038152,17341427:1912595,17563816:486804,16281191:1,17782153:1966374,23757402:2748151,14701552:1610687,7780:2492816,25903468:2983328,17303:4879,16549426:1871617,20057:87200,25063570:2945938,17194913:2356971,12480:90099,2146169:745493,13639277:1483046,22029634:3312521,241786:24481,10505822:1982142,16273723:1776601,2840:26691,532908:57069,10543:2497725,9976316:1990711,14701545:1610687,5426:584,26249615:3119071,26719974:3187221,23331752:2686581,975:6041,814369:2490407,21501887:2522992,801222:89409,15772:2509219,14690773:1609071,26309960:3127880,9966390:1068284,10506346:1137181,16524290:1808865,20217926:2825507,4376:88388,41315:3485809,7554:791,14701557:1610687,9951085:1833649,9966150:1068194,22473:4855,16177514:1828357,36661:86066,68235:60492,18827:6303,547688:58707,5251304:578913,12743:1688367,3692242:413035,16408653:1795815,370814:37772,1598248:160556,9976314:1990711,7556:791,813824:409676,4209889:474188,530401:2488278,27965:2345,2890529:445743,20469853:2329909,15761:2509219,15995253:1745266,10509962:1137588,3703084:1597165,20717346:2363425,529895:56829,37384:89827,18644154:2074429,15495586:1698735,15039:1397,2137790:210831,16780420:1840373,17311408:1908313,9987082:1073131,3670311:1133973,12502:1189,9474:957,14701549:1610687,2470798:261513,434900:45004,15271:3548,15753487:1716258,18900642:2110710,70397:5977,532906:57069,4197120:1999283,18371442:2067116,529882:56829,67884:2243022,12364:3184989,17278443:2305595,9328:2757069,20053:86419,14182015:1543767,18079551:2003176,10451976:1132000,6314570:688566,14701542:1610687,25905123:3069240,9968132:1782091,14688968:1608769,9459474:1003108,12846:1738,7284:8213,3874601:434317,9610:9341,16273721:1776601,14264:1336,21611146:2476503,4196922:561528,17311412:1908313,545939:58505,9444267:1694122,9447618:1099950,1057951:119384,16321483:1784392,8403762:1165233,14701553:1610687,28148549:3363140,39387:2494169,9769:2463,23752:4973,9439965:1116658,560468:60062,3962293:446009,15782:1588,4752890:529904,17826994:3216062,14283:1336,20469833:2329909,14200:1330,23099862:2656609,2628253:273026,18351182:2038152,17341427:1912595,17563816:486804,16281191:1')
    get_latest()
    # extend_stored_tracks_with_url()
    # download_tracks()
